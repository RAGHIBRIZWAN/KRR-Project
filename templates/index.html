<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Five Personality Assessment</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        /* Login Section */
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 50px 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .logo-icon svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 15px;
            margin-bottom: 35px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Assessment Section */
        .assessment-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: fadeInUp 0.6s ease-out;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #6b7280;
        }

        .progress-text span:first-child {
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.4s ease;
        }

        .question-container {
            min-height: 280px;
            display: flex;
            flex-direction: column;
        }

        .question-wrapper {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .trait-badge {
            display: inline-block;
            padding: 6px 14px;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
            color: #667eea;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 22px;
            font-weight: 600;
            color: #1a1a2e;
            line-height: 1.4;
            margin-bottom: 35px;
        }

        .rating-scale {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rating-option {
            flex: 1;
            position: relative;
        }

        .rating-option input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 10;
        }

        .rating-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 10px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rating-option input:checked + .rating-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .rating-number {
            font-size: 24px;
            font-weight: 700;
            color: #374151;
            transition: color 0.3s ease;
        }

        .rating-option input:checked + .rating-label .rating-number {
            color: white;
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            color: #9ca3af;
            font-size: 12px;
            padding: 0 5px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-secondary {
            flex: 1;
            padding: 14px 24px;
            background: #f3f4f6;
            color: #4b5563;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-next {
            flex: 2;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Modal Popup */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 35px 40px;
            text-align: center;
            position: relative;
        }

        .modal-header h2 {
            color: white;
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .modal-header p {
            color: rgba(255, 255, 255, 0.85);
            font-size: 15px;
        }

        .confetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .modal-body {
            padding: 35px 40px;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .score-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .score-trait {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .score-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-bar-container {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            transition: width 1s ease;
        }

        .performance-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #fcd34d;
        }

        .performance-title {
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .performance-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .performance-label {
            font-size: 12px;
            color: #92400e;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .performance-value {
            font-size: 24px;
            font-weight: 700;
            color: #78350f;
        }

        .analysis-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid #86efac;
        }

        .analysis-title {
            font-size: 16px;
            font-weight: 700;
            color: #166534;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-content {
            color: #15803d;
            font-size: 14px;
            line-height: 1.8;
        }

        .analysis-content h3 {
            font-size: 16px;
            font-weight: 700;
            color: #166534;
            margin: 20px 0 10px 0;
        }

        .analysis-content strong {
            color: #14532d;
        }

        .modal-footer {
            padding: 20px 40px 35px;
            display: flex;
            gap: 15px;
        }

        .btn-restart {
            flex: 1;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-restart:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }

        .loading-subtext {
            font-size: 14px;
            color: #6b7280;
            margin-top: 8px;
        }

        /* Hidden utility */
        .hidden {
            display: none !important;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            max-width: 350px;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.info {
            border-left: 4px solid #667eea;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 18px;
            margin-left: auto;
            padding: 0;
        }

        .toast-close:hover {
            color: #374151;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Responsive */
        @media (max-width: 640px) {
            .login-card, .assessment-card {
                padding: 30px 25px;
            }

            .modal-header, .modal-body, .modal-footer {
                padding-left: 25px;
                padding-right: 25px;
            }

            .question-text {
                font-size: 18px;
            }

            .rating-label {
                padding: 15px 8px;
            }

            .rating-number {
                font-size: 20px;
            }

            .performance-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Login Section -->
    <div id="login-section" class="login-card">
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <h1>Big Five Personality</h1>
            <p class="subtitle">Discover your unique personality profile through our scientific assessment</p>
        </div>

        <div class="form-group">
            <label for="userName">Your Name</label>
            <input type="text" id="userName" placeholder="Enter your full name">
        </div>

        <div class="form-group">
            <label for="userId">User ID</label>
            <input type="text" id="userId" placeholder="Create a unique identifier">
        </div>

        <button class="btn-primary" onclick="handleLogin()">
            Start Assessment ‚Üí
        </button>
    </div>

    <!-- Assessment Section -->
    <div id="assessment-section" class="assessment-card hidden">
        <div class="progress-container">
            <div class="progress-text">
                <span id="progress-label">Question 1 of 50</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="question-container" id="question-container">
            <!-- Questions will be loaded here -->
        </div>

        <div class="nav-buttons">
            <button class="btn-secondary" id="btn-prev" onclick="previousQuestion()" disabled>
                ‚Üê Previous
            </button>
            <button class="btn-next" id="btn-next" onclick="nextQuestion()" disabled>
                Next ‚Üí
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Analyzing Your Personality</div>
    <div class="loading-subtext">Our AI is generating personalized insights...</div>
</div>

<!-- Results Modal -->
<div class="modal-overlay" id="results-modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="confetti" id="confetti"></div>
            <h2>üéâ Your Personality Profile</h2>
            <p id="user-greeting">Great job completing the assessment!</p>
        </div>

        <div class="modal-body">
            <div class="scores-grid" id="scores-grid">
                <!-- Scores will be populated here -->
            </div>

            <div class="performance-section" id="performance-section">
                <div class="performance-title">
                    üìä Performance Predictions
                </div>
                <div class="performance-grid" id="performance-grid">
                    <!-- Performance predictions will be populated here -->
                </div>
            </div>

            <div class="analysis-section">
                <div class="analysis-title">
                    ü§ñ AI-Powered Analysis
                </div>
                <div class="analysis-content" id="analysis-content">
                    Loading insights...
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-restart" onclick="restartAssessment()">
                Take Assessment Again
            </button>
        </div>
    </div>
</div>

<script>
    // Constants
    const AUTO_ADVANCE_DELAY_MS = 300;

    // State
    let questionsMetaData = [];
    let currentQuestionIndex = 0;
    let answers = {};

    // Utility: Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Utility: Validate and clamp numeric score to 0-100 range
    function validateScore(score) {
        const num = parseFloat(score);
        if (isNaN(num)) return 0;
        return Math.max(0, Math.min(100, num));
    }

    // Utility: Sanitize markdown-like text (basic sanitization)
    function sanitizeAnalysis(text) {
        if (!text) return '';
        // First escape HTML entities
        let sanitized = escapeHtml(text);
        // Then apply safe formatting with restrictive patterns
        // Only allow simple word characters and spaces in matched content
        sanitized = sanitized
            .replace(/\n/g, "<br>")
            .replace(/\*\*([^*<>]+)\*\*/g, "<strong>$1</strong>")
            .replace(/### ([^<>\n]+)(?:&lt;br&gt;|<br>|$)/g, "<h3>$1</h3>")
            .replace(/\* /g, "‚Ä¢ ");
        return sanitized;
    }

    // Handle Login
    async function handleLogin() {
        const name = document.getElementById('userName').value.trim();
        const id = document.getElementById('userId').value.trim();

        if (!name || !id) {
            showNotification('Please fill in all fields', 'error');
            return;
        }

        // Load questions
        await loadQuestions();

        if (questionsMetaData.length === 0) {
            showNotification('No questions available. Please check if the server is running.', 'error');
            return;
        }

        // Switch screens
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('assessment-section').classList.remove('hidden');

        // Display first question
        displayQuestion(0);
    }

    // Load Questions from Backend
    async function loadQuestions() {
        try {
            const response = await fetch('/get_questions');
            questionsMetaData = await response.json();
        } catch (error) {
            console.error("Error loading questions:", error);
            showNotification('Could not load questions. Is the server running?', 'error');
        }
    }

    // Display a Single Question
    function displayQuestion(index) {
        const container = document.getElementById('question-container');
        const question = questionsMetaData[index];
        const total = questionsMetaData.length;

        // Update progress
        const progress = ((index) / total) * 100;
        document.getElementById('progress-label').textContent = `Question ${index + 1} of ${total}`;
        document.getElementById('progress-percent').textContent = `${Math.round(progress)}%`;
        document.getElementById('progress-fill').style.width = `${progress}%`;

        // Get previously selected value
        const selectedValue = answers[question.id] || null;

        // Create question HTML
        container.innerHTML = `
            <div class="question-wrapper">
                <span class="trait-badge">${formatTrait(question.trait)}</span>
                <p class="question-text">${question.text}</p>

                <div class="rating-scale">
                    ${[1, 2, 3, 4, 5].map(val => `
                        <div class="rating-option">
                            <input type="radio" 
                                   name="q_${question.id}" 
                                   id="q_${question.id}_${val}" 
                                   value="${val}"
                                   ${selectedValue === val ? 'checked' : ''}
                                   onchange="handleAnswer('${question.id}', ${val})">
                            <label class="rating-label" for="q_${question.id}_${val}">
                                <span class="rating-number">${val}</span>
                            </label>
                        </div>
                    `).join('')}
                </div>

                <div class="scale-labels">
                    <span>Strongly Disagree</span>
                    <span>Strongly Agree</span>
                </div>
            </div>
        `;

        // Update navigation buttons
        updateNavButtons();
    }

    // Format trait name for display
    function formatTrait(trait) {
        const traitMap = {
            'Extraversion': 'üåü Extraversion',
            'Neuroticism': 'üß† Emotional Stability',
            'Agreeableness': 'üíö Agreeableness',
            'Conscientiousness': 'üéØ Conscientiousness',
            'Openness': 'üí° Openness',
            'Unknown': '‚ùì General'
        };
        return traitMap[trait] || trait;
    }

    // Handle Answer Selection
    function handleAnswer(questionId, value) {
        answers[questionId] = value;
        updateNavButtons();

        // Auto-advance after a short delay for better UX
        if (currentQuestionIndex < questionsMetaData.length - 1) {
            setTimeout(() => {
                nextQuestion();
            }, AUTO_ADVANCE_DELAY_MS);
        }
    }

    // Update Navigation Buttons
    function updateNavButtons() {
        const prevBtn = document.getElementById('btn-prev');
        const nextBtn = document.getElementById('btn-next');
        const currentQuestion = questionsMetaData[currentQuestionIndex];
        const isAnswered = answers[currentQuestion.id] !== undefined;
        const isLast = currentQuestionIndex === questionsMetaData.length - 1;

        prevBtn.disabled = currentQuestionIndex === 0;
        nextBtn.disabled = !isAnswered;
        nextBtn.textContent = isLast ? 'View Results ‚Üí' : 'Next ‚Üí';
    }

    // Go to Previous Question
    function previousQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            displayQuestion(currentQuestionIndex);
        }
    }

    // Go to Next Question
    function nextQuestion() {
        const currentQuestion = questionsMetaData[currentQuestionIndex];

        if (!answers[currentQuestion.id]) {
            showNotification('Please select an answer before continuing', 'info');
            return;
        }

        if (currentQuestionIndex < questionsMetaData.length - 1) {
            currentQuestionIndex++;
            displayQuestion(currentQuestionIndex);
        } else {
            // Submit assessment
            submitAssessment();
        }
    }

    // Submit Assessment
    async function submitAssessment() {
        const name = document.getElementById('userName').value;
        const id = document.getElementById('userId').value;

        // Show loading
        document.getElementById('loading-overlay').classList.add('active');

        try {
            const response = await fetch('/submit_assessment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, id, answers })
            });

            const result = await response.json();

            // Hide loading
            document.getElementById('loading-overlay').classList.remove('active');

            // Display results in modal
            displayResults(result, name);

        } catch (error) {
            document.getElementById('loading-overlay').classList.remove('active');
            console.error(error);
            showNotification('Error calculating scores. Please try again.', 'error');
        }
    }

    // Display Results in Modal
    function displayResults(result, userName) {
        // Set greeting (using textContent is safe for XSS)
        document.getElementById('user-greeting').textContent = 
            `Great job, ${userName}! Here's your personality profile.`;

        // Populate scores
        const scoresGrid = document.getElementById('scores-grid');
        scoresGrid.innerHTML = '';

        for (const [trait, score] of Object.entries(result.scores)) {
            const validatedScore = validateScore(score);
            const escapedTrait = escapeHtml(trait);
            const escapedScore = escapeHtml(String(score));
            scoresGrid.innerHTML += `
                <div class="score-item">
                    <div class="score-trait">${escapedTrait}</div>
                    <div class="score-value">${escapedScore}</div>
                    <div class="score-bar-container">
                        <div class="score-bar-fill" style="width: ${validatedScore}%"></div>
                    </div>
                </div>
            `;
        }

        // Populate performance predictions
        const performanceGrid = document.getElementById('performance-grid');
        if (result.performance) {
            const jobPerf = validateScore(result.performance.JobPerformance);
            const acadPerf = validateScore(result.performance.AcademicPerformance);
            performanceGrid.innerHTML = `
                <div class="performance-item">
                    <div class="performance-label">Job Performance</div>
                    <div class="performance-value">${jobPerf}%</div>
                </div>
                <div class="performance-item">
                    <div class="performance-label">Academic Performance</div>
                    <div class="performance-value">${acadPerf}%</div>
                </div>
            `;
        }

        // Populate AI analysis (sanitized)
        const analysisContent = document.getElementById('analysis-content');
        if (result.analysis) {
            analysisContent.innerHTML = sanitizeAnalysis(result.analysis);
        } else {
            analysisContent.innerHTML = '<p>Analysis not available.</p>';
        }

        // Show modal with animation
        setTimeout(() => {
            document.getElementById('results-modal').classList.add('active');
            createConfetti();
        }, 100);
    }

    // Create Confetti Animation
    function createConfetti() {
        const confettiContainer = document.getElementById('confetti');
        confettiContainer.innerHTML = '';

        const colors = ['#667eea', '#764ba2', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6'];

        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
                position: absolute;
                width: ${Math.random() * 10 + 5}px;
                height: ${Math.random() * 10 + 5}px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                left: ${Math.random() * 100}%;
                top: -20px;
                border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                animation: confettiFall ${Math.random() * 2 + 2}s ease-out forwards;
                animation-delay: ${Math.random() * 0.5}s;
            `;
            confettiContainer.appendChild(confetti);
        }

        // Add confetti animation styles
        if (!document.getElementById('confetti-styles')) {
            const style = document.createElement('style');
            style.id = 'confetti-styles';
            style.textContent = `
                @keyframes confettiFall {
                    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                    100% { transform: translateY(200px) rotate(720deg); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Restart Assessment
    function restartAssessment() {
        // Reset state
        currentQuestionIndex = 0;
        answers = {};
        questionsMetaData = [];

        // Hide modal
        document.getElementById('results-modal').classList.remove('active');

        // Show login section
        document.getElementById('assessment-section').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');

        // Clear form inputs
        document.getElementById('userName').value = '';
        document.getElementById('userId').value = '';
    }

    // Toast notification function
    function showNotification(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            error: '‚ùå',
            success: '‚úÖ',
            info: '‚ÑπÔ∏è'
        };
        
        // Build toast using DOM methods for safety (textContent prevents XSS)
        const iconSpan = document.createElement('span');
        iconSpan.className = 'toast-icon';
        iconSpan.textContent = icons[type] || icons.info;
        
        const messageSpan = document.createElement('span');
        messageSpan.className = 'toast-message';
        messageSpan.textContent = message;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'toast-close';
        closeBtn.textContent = '√ó';
        closeBtn.onclick = () => toast.remove();
        
        toast.appendChild(iconSpan);
        toast.appendChild(messageSpan);
        toast.appendChild(closeBtn);
        
        container.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'toastSlideOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }
</script>

</body>
</html>
